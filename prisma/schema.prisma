// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========================================
// Catálogos
// ========================================

model ProductCategory {
  id        Int        @id @default(autoincrement())
  name      String     @unique @db.VarChar(100)
  deleted   Boolean    @default(false)
  products  Product[]
  suppliers SupplierCategory[]
  promotion_categories PromotionCategory[]

  @@map("product_categories")
}

model Status {
  id        Int        @id @default(autoincrement())
  name      String     @unique @db.VarChar(50)
  suppliers Supplier[]
  alerts    Alert[]

  @@map("statuses")
}

model StockStatus {
  id       Int       @id @default(autoincrement())
  name     String    @unique @db.VarChar(50)
  products Product[]

  @@map("stock_statuses")
}

model PaymentMethod {
  id                     Int                    @id @default(autoincrement())
  name                   String                 @unique @db.VarChar(50)
  sales                  Sale[]
  cash_closure_payments  CashClosurePayment[]  // Relación para saber qué método de pago se usó en cada línea del cierre

  @@map("payment_methods")
}

model SaleStatus {
  id    Int    @id @default(autoincrement())
  name  String @unique @db.VarChar(50)
  sales Sale[]

  @@map("sale_statuses")
}

model ReturnStatus {
  id      Int      @id @default(autoincrement())
  name    String   @unique @db.VarChar(50)
  returns Return[]

  @@map("return_statuses")
}

model PaymentTerm {
  id        Int        @id @default(autoincrement())
  name      String     @unique @db.VarChar(50)
  deleted   Boolean    @default(false)
  suppliers Supplier[]

  @@map("payment_terms")
}

model AlertType {
  id     Int     @id @default(autoincrement())
  name   String  @unique @db.VarChar(50)
  alerts Alert[]

  @@map("alert_types")
}

model AlertPriority {
  id     Int     @id @default(autoincrement())
  name   String  @unique @db.VarChar(50)
  alerts Alert[]

  @@map("alert_priorities")
}

// ========================================
// Entidades principales
// ========================================

model Supplier {
  id               String          @id @default(uuid()) @db.Uuid
  name             String          @db.VarChar(150)
  contact          String          @db.VarChar(100)
  phone            String?         @db.VarChar(50)
  email            String?         @db.VarChar(150)
  address          String?         @db.Text
  products         Int             @default(0)
  last_order       DateTime?
  total_purchases  Decimal         @default(0) @db.Decimal(12, 2)
  rating           Decimal?        @db.Decimal(3, 2)
  status_id        Int
  status           Status          @relation(fields: [status_id], references: [id])
  payment_terms_id Int
  payment_term     PaymentTerm     @relation(fields: [payment_terms_id], references: [id])
  categories       SupplierCategory[]
  productsList     Product[]
  purchase_logs    PurchaseLog[]
  incoming_merchandise IncomingMerchandise[]
  deleted          Boolean         @default(false)
  deleted_at       DateTime?

  @@map("suppliers")
}

model Product {
  id            String          @id @default(uuid()) @db.Uuid
  name          String          @db.VarChar(150)
  category_id   Int
  category      ProductCategory @relation(fields: [category_id], references: [id])
  brand         String?         @db.VarChar(100)
  size          String?         @db.VarChar(50)
  stock         Int             @default(0)
  min_stock     Int             @default(0)
  price         Decimal         @db.Decimal(12, 2)
  cost          Decimal         @db.Decimal(12, 2)
  image_url     String?         @db.VarChar(500)
  supplier_id   String          @db.Uuid
  supplier      Supplier        @relation(fields: [supplier_id], references: [id])
  barcode       String?         @unique @db.VarChar(100)
  description   String?         @db.Text
  deleted       Boolean         @default(false)
  deleted_at    DateTime?
  status_id     Int
  status        StockStatus     @relation(fields: [status_id], references: [id])
  alerts        Alert[]
  sale_items    SaleItem[]
  purchase_logs PurchaseLog[]
  return_items  ReturnItem[]
  promotion_products PromotionProduct[]
  incoming_merchandise_items IncomingMerchandiseItem[]

  @@map("products")
}

model Role {
  id          Int              @id @default(autoincrement())
  name        String           @unique @db.VarChar(50)
  users       User[]
  permissions RolePermission[]

  @@map("roles")
}

/// Sistema de permisos granular por rol
model Permission {
  id          Int              @id @default(autoincrement())
  code        String           @unique @db.VarChar(100)
  name        String           @db.VarChar(150)
  description String?          @db.Text
  roles       RolePermission[]

  @@map("permissions")
}

model RolePermission {
  role_id       Int
  permission_id Int

  role       Role       @relation(fields: [role_id], references: [id])
  permission Permission @relation(fields: [permission_id], references: [id])

  @@id([role_id, permission_id])
  @@map("role_permissions")
}

model User {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @db.VarChar(150)
  email       String  @unique @db.VarChar(150)
  password    String  @db.VarChar(255)
  role_id     Int
  role        Role    @relation(fields: [role_id], references: [id])
  alerts      Alert[] @relation("AlertAssignedTo")
  incoming_merchandise IncomingMerchandise[]
  
  // Campos de empleado
  is_employee Boolean @default(false)
  photo_url   String? @db.VarChar(500)
  phone       String? @db.VarChar(50)
  address     String? @db.Text
  hire_date   DateTime? // Fecha de contratación
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("users")
}

model Alert {
  id            String        @id @default(uuid()) @db.Uuid
  type_id       Int
  type          AlertType     @relation(fields: [type_id], references: [id])
  priority_id   Int
  priority      AlertPriority @relation(fields: [priority_id], references: [id])
  title         String        @db.VarChar(150)
  message       String?
  product_id    String        @db.Uuid
  product       Product       @relation(fields: [product_id], references: [id])
  current_stock Int?
  min_stock     Int?
  timestamp     DateTime      @default(now())
  status_id     Int
  status        Status        @relation(fields: [status_id], references: [id])
  assigned_to   String?       @db.Uuid
  assignedTo    User?         @relation(fields: [assigned_to], references: [id], name: "AlertAssignedTo")
  resolved      Int           @default(0)

  @@map("alerts")
}

model Sale {
  id                String        @id @default(uuid()) @db.Uuid
  date              DateTime      @default(now())
  customer          String?       @db.VarChar(150)
  customer_nit      String?       @db.VarChar(50)
  is_final_consumer Boolean       @default(true)
  subtotal          Decimal?      @db.Decimal(12, 2)  // Total antes de descuentos
  discount_total    Decimal?      @db.Decimal(12, 2)  // Total de descuentos aplicados
  total             Decimal       @db.Decimal(12, 2)
  total_returned    Decimal       @default(0) @db.Decimal(12, 2)
  adjusted_total    Decimal       @db.Decimal(12, 2)
  items             Int
  payment_method_id Int
  payment_method    PaymentMethod @relation(fields: [payment_method_id], references: [id])
  status_id         Int
  status            SaleStatus    @relation(fields: [status_id], references: [id])
  amount_received   Decimal?      @db.Decimal(12, 2)
  change            Decimal?      @db.Decimal(12, 2)
  sale_items        SaleItem[]
  returns           Return[]
  sale_promotions   SalePromotion[]
  sold_at           DateTime      @default(now())

  @@map("sales")
}

model SaleItem {
  id           Int          @id @default(autoincrement())
  sale_id      String       @db.Uuid
  sale         Sale         @relation(fields: [sale_id], references: [id])
  product_id   String       @db.Uuid
  product      Product      @relation(fields: [product_id], references: [id])
  price        Decimal      @db.Decimal(12, 2)
  qty          Int
  return_items ReturnItem[]

  @@map("sale_items")
}

model PurchaseLog {
  id          Int      @id @default(autoincrement())
  product_id  String   @db.Uuid
  product     Product  @relation(fields: [product_id], references: [id])
  supplier_id String   @db.Uuid
  supplier    Supplier @relation(fields: [supplier_id], references: [id])
  qty         Int
  date        DateTime @default(now())
  cost        Decimal  @db.Decimal(12, 2)

  @@index([product_id])
  @@index([supplier_id])
  @@map("purchase_logs")
}

/// Relación many-to-many entre proveedores y categorías de producto
model SupplierCategory {
  supplier_id String          @db.Uuid
  category_id Int

  supplier    Supplier        @relation(fields: [supplier_id], references: [id], onDelete: Cascade)
  category    ProductCategory @relation(fields: [category_id], references: [id])

  @@id([supplier_id, category_id])
  @@map("supplier_categories")
}

/// Registro de auditoría para ingresos de mercancía
model IncomingMerchandise {
  id          String                      @id @default(uuid()) @db.Uuid
  supplier_id String                      @db.Uuid
  supplier    Supplier                    @relation(fields: [supplier_id], references: [id])
  registered_by String                     @db.Uuid
  registeredBy User                        @relation(fields: [registered_by], references: [id])
  date        DateTime                    @default(now())
  notes       String?                     @db.Text
  items       IncomingMerchandiseItem[]

  @@index([supplier_id])
  @@index([registered_by])
  @@index([date])
  @@map("incoming_merchandise")
}

model IncomingMerchandiseItem {
  id                      String              @id @default(uuid()) @db.Uuid
  incoming_merchandise_id String              @db.Uuid
  incomingMerchandise     IncomingMerchandise @relation(fields: [incoming_merchandise_id], references: [id], onDelete: Cascade)
  product_id              String              @db.Uuid
  product                 Product             @relation(fields: [product_id], references: [id])
  quantity                Int
  unit_cost               Decimal             @db.Decimal(12, 2)

  @@index([incoming_merchandise_id])
  @@index([product_id])
  @@map("incoming_merchandise_items")
}

model Return {
  id           String       @id @default(uuid()) @db.Uuid
  sale_id      String       @db.Uuid
  sale         Sale         @relation(fields: [sale_id], references: [id])
  return_date  DateTime     @default(now())
  reason       String?      @db.Text
  total_refund Decimal      @db.Decimal(12, 2)
  items_count  Int          @default(0)
  status_id    Int
  status       ReturnStatus @relation(fields: [status_id], references: [id])
  processed_by String?      @db.Uuid
  processed_at DateTime?
  notes        String?      @db.Text

  return_items ReturnItem[]

  @@index([sale_id])
  @@index([status_id])
  @@map("returns")
}

model ReturnItem {
  id            Int      @id @default(autoincrement())
  return_id     String   @db.Uuid
  return        Return   @relation(fields: [return_id], references: [id])
  sale_item_id  Int
  sale_item     SaleItem @relation(fields: [sale_item_id], references: [id])
  product_id    String   @db.Uuid
  product       Product  @relation(fields: [product_id], references: [id])
  qty_returned  Int
  refund_amount Decimal  @db.Decimal(12, 2)
  reason        String?  @db.Text

  @@index([return_id])
  @@index([sale_item_id])
  @@index([product_id])
  @@map("return_items")
}

// ========================================
// Cierre de Caja
// ========================================

model CashClosure {
  id                    String                  @id @default(uuid()) @db.Uuid
  closure_number        Int                     @unique @default(autoincrement())
  date                  DateTime                @default(now())
  start_date            DateTime // Fecha/hora de inicio del período
  end_date              DateTime // Fecha/hora de fin del período
  
  // Usuario que genera el cierre
  cashier_name          String                  @db.VarChar(100)
  cashier_signature     String?                 @db.Text // Base64 de firma digital
  
  // Supervisor que valida
  supervisor_name       String?                 @db.VarChar(100)
  supervisor_signature  String?                 @db.Text // Base64 de firma digital
  supervisor_validated_at DateTime?
  
  // Totales teóricos (según BD)
  theoretical_total     Decimal                 @db.Decimal(12, 2)
  theoretical_sales     Decimal                 @db.Decimal(12, 2)
  theoretical_returns   Decimal                 @db.Decimal(12, 2)
  
  // Totales reales (conteo físico/validación)
  actual_total          Decimal                 @db.Decimal(12, 2)
  
  // Diferencia
  difference            Decimal                 @db.Decimal(12, 2) // actual - theoretical
  difference_percentage Decimal?                @db.Decimal(5, 2)
  
  // Desglose por método de pago
  payment_breakdowns    CashClosurePayment[]
  
  // Conteo de denominaciones (billetes/monedas)
  denominations         CashClosureDenomination[]
  
  // Métricas adicionales
  total_transactions    Int // Total de ventas en el período
  total_customers       Int // Total de clientes atendidos
  average_ticket        Decimal                 @db.Decimal(12, 2)
  
  // Notas y observaciones
  notes                 String?                 @db.Text
  status                String                  @default("Pendiente") @db.VarChar(50) // Pendiente, Validado, Cerrado
  
  // Timestamps
  created_at            DateTime                @default(now())
  updated_at            DateTime                @updatedAt
  
  @@index([date])
  @@index([status])
  @@map("cash_closures")
}

model CashClosurePayment {
  id                    Int         @id @default(autoincrement())
  cash_closure_id       String      @db.Uuid
  cash_closure          CashClosure @relation(fields: [cash_closure_id], references: [id], onDelete: Cascade)
  
  payment_method_id     Int
  payment_method        PaymentMethod @relation(fields: [payment_method_id], references: [id])
  
  // Teórico (según BD)
  theoretical_amount    Decimal     @db.Decimal(12, 2)
  theoretical_count     Int // Cantidad de transacciones
  
  // Real (conteo/validación)
  actual_amount         Decimal     @db.Decimal(12, 2)
  actual_count          Int?
  
  // Diferencia
  difference            Decimal     @db.Decimal(12, 2)
  
  // Notas específicas por método
  notes                 String?     @db.Text
  
  @@index([cash_closure_id])
  @@index([payment_method_id])
  @@map("cash_closure_payments")
}

model CashClosureDenomination {
  id                Int         @id @default(autoincrement())
  cash_closure_id   String      @db.Uuid
  cash_closure      CashClosure @relation(fields: [cash_closure_id], references: [id], onDelete: Cascade)
  
  // Denominación (200, 100, 50, 20, 10, 5, 1, 0.50, 0.25, 0.10, 0.05, 0.01)
  denomination      Decimal     @db.Decimal(10, 2)
  type              String      @db.VarChar(20) // "Billete" o "Moneda"
  
  // Cantidad de unidades
  quantity          Int
  
  // Subtotal (denomination * quantity)
  subtotal          Decimal     @db.Decimal(12, 2)
  
  @@index([cash_closure_id])
  @@map("cash_closure_denominations")
}

// ========================================
// Sistema de Promociones y Descuentos
// ========================================

model PromotionType {
  id          Int         @id @default(autoincrement())
  name        String      @unique @db.VarChar(50)
  // Tipos: PERCENTAGE, FIXED_AMOUNT, BUY_X_GET_Y, COMBO_DISCOUNT, FREE_GIFT, MIN_QTY_DISCOUNT
  description String?     @db.Text
  promotions  Promotion[]

  @@map("promotion_types")
}

model Promotion {
  id                  String    @id @default(uuid()) @db.Uuid
  name                String    @db.VarChar(150)
  description         String?   @db.Text
  type_id             Int
  type                PromotionType @relation(fields: [type_id], references: [id])
  
  // Códigos vinculados (uno o varios)
  codes               PromotionCode[]
  
  // Valores de la promoción
  discount_value      Decimal?  @db.Decimal(12, 2)   // Para FIXED_AMOUNT
  discount_percentage Decimal?  @db.Decimal(5, 2)    // Porcentaje (0-100)
  buy_quantity        Int?      // Cantidad a comprar (2x1 = 2)
  get_quantity        Int?      // Cantidad gratis (2x1 = 1)
  min_quantity        Int?      // Cantidad mínima para aplicar
  
  // Productos relacionados
  applies_to_all      Boolean   @default(false)      // Aplica a todos los productos
  trigger_product_id  String?   @db.Uuid             // Producto que activa la promo
  target_product_id   String?   @db.Uuid             // Producto que recibe el descuento/regalo
  applicable_products PromotionProduct[]
  applicable_categories PromotionCategory[]
  
  // Validez y límites
  start_date          DateTime  @default(now())
  end_date            DateTime?
  max_uses            Int?      // Usos máximos totales (por código)
  max_uses_per_customer Int?    // Usos máximos por cliente
  min_purchase_amount Decimal?  @db.Decimal(12, 2)   // Compra mínima para aplicar
  
  // Estado
  active              Boolean   @default(true)
  deleted             Boolean   @default(false)
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt
  
  // Relaciones
  sale_promotions     SalePromotion[]
  
  @@index([active, start_date, end_date])
  @@map("promotions")
}

// Códigos de promoción (permite múltiples códigos por promoción)
model PromotionCode {
  id            Int       @id @default(autoincrement())
  code          String    @unique @db.VarChar(50)
  promotion_id  String    @db.Uuid
  promotion     Promotion @relation(fields: [promotion_id], references: [id], onDelete: Cascade)
  current_uses  Int       @default(0)
  active        Boolean   @default(true)
  created_at    DateTime  @default(now())
  
  @@index([code])
  @@index([promotion_id])
  @@map("promotion_codes")
}

model PromotionProduct {
  id           Int       @id @default(autoincrement())
  promotion_id String    @db.Uuid
  promotion    Promotion @relation(fields: [promotion_id], references: [id], onDelete: Cascade)
  product_id   String    @db.Uuid
  product      Product   @relation(fields: [product_id], references: [id])
  
  @@unique([promotion_id, product_id])
  @@map("promotion_products")
}

model PromotionCategory {
  id           Int             @id @default(autoincrement())
  promotion_id String          @db.Uuid
  promotion    Promotion       @relation(fields: [promotion_id], references: [id], onDelete: Cascade)
  category_id  Int
  category     ProductCategory @relation(fields: [category_id], references: [id])
  
  @@unique([promotion_id, category_id])
  @@map("promotion_categories")
}

model SalePromotion {
  id               Int       @id @default(autoincrement())
  sale_id          String    @db.Uuid
  sale             Sale      @relation(fields: [sale_id], references: [id], onDelete: Cascade)
  promotion_id     String    @db.Uuid
  promotion        Promotion @relation(fields: [promotion_id], references: [id])
  discount_applied Decimal   @db.Decimal(12, 2)  // Monto efectivo descontado
  code_used        String?   @db.VarChar(50)     // Código específico utilizado
  
  @@index([sale_id])
  @@index([promotion_id])
  @@map("sale_promotions")
}

